name: WireGuard Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üß∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard
        run: |
          sudo apt update
          sudo apt install -y wireguard curl

      - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–æ VPN
        run: |
          echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS:"
          curl -s https://ipinfo.io/ip || echo "‚ùå curl –¥–æ ipinfo.io –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª"
          echo "üì∂ –ü–∏–Ω–≥ –¥–æ IP VPN —Å–µ—Ä–≤–µ—Ä–∞:"
          ping -c 4 45.77.30.118 || echo "‚ùå –°–µ—Ä–≤–µ—Ä VPN –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping"

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: |
          sudo mkdir -p /etc/wireguard
          echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf
          echo "PrivateKey = gAyGrUttLdgh+ENPy7os9vFLycJgn6PC3XuANg6RAWg=" | sudo tee -a /etc/wireguard/wg0.conf
          echo "Address = 10.1.0.2/32" | sudo tee -a /etc/wireguard/wg0.conf
          echo "DNS = 1.1.1.1" | sudo tee -a /etc/wireguard/wg0.conf
          echo "" | sudo tee -a /etc/wireguard/wg0.conf
          echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PublicKey = /2MM4ThCUi3SEckHKqduAK/I09gMXoPSQIQR0H63ZAw=" | sudo tee -a /etc/wireguard/wg0.conf
          echo "AllowedIPs = 0.0.0.0/0, ::/0" | sudo tee -a /etc/wireguard/wg0.conf
          echo "Endpoint = 45.77.30.118:51821" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PersistentKeepalive = 25" | sudo tee -a /etc/wireguard/wg0.conf

      - name: üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN
        run: |
          sudo wg-quick up wg0
          echo "üéØ WireGuard —Å—Ç–∞—Ç—É—Å:"
          sudo wg show

      - name: üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ IP —á–µ—Ä–µ–∑ VPN
        run: |
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          sleep 3
          echo "üåç IP —á–µ—Ä–µ–∑ VPN:"
          curl -s https://ipinfo.io/ip || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP —á–µ—Ä–µ–∑ curl"

      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ VPN
        run: |
          ping -c 4 1.1.1.1 || echo "‚ùå Ping —á–µ—Ä–µ–∑ VPN –Ω–µ –ø—Ä–æ—à—ë–ª"

      - name: üì¥ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
        if: always()
        run: |
          sudo wg-quick down wg0
