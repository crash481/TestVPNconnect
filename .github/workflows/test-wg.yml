name: WireGuard Test

on:
  schedule:
    - cron: '*/3 * * * *'  # –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã (UTC)
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üß∞ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WireGuard
        run: |
          set -x
          sudo apt update
          sudo apt install -y wireguard curl

      - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –î–û VPN
        run: |
          set -x
          echo "::group::IP –¥–æ VPN"
          echo "ipinfo.io:"
          curl https://ipinfo.io/ip || echo "‚ùå"
          echo ""
          echo "ifconfig.me:"
          curl https://ifconfig.me || echo "‚ùå"
          echo ""
          echo "api.myip.com:"
          curl https://api.myip.com || echo "‚ùå"
          echo "::endgroup::"
          echo "::notice ::–ó–∞–≤–µ—Ä—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –¥–æ VPN"

          echo "::group::Ping –¥–æ VPN-—Å–µ—Ä–≤–µ—Ä–∞"
          ping -c 4 45.77.30.118 || echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping (—ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ)"
          echo "::endgroup::"
          echo "::notice ::–ó–∞–≤–µ—Ä—à—ë–Ω ping –¥–æ VPN"

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ WireGuard –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        run: |
          set -x
          sudo mkdir -p /etc/wireguard
          echo "[Interface]" | sudo tee /etc/wireguard/wg0.conf
          echo "PrivateKey = +A0xwOmODtspeXWHWmnFnbCsCAKnIWP55HQjnjluRmU=" | sudo tee -a /etc/wireguard/wg0.conf
          echo "Address = 10.2.2.162/32" | sudo tee -a /etc/wireguard/wg0.conf
          echo "DNS = 1.1.1.1" | sudo tee -a /etc/wireguard/wg0.conf
          echo "" | sudo tee -a /etc/wireguard/wg0.conf
          echo "[Peer]" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PublicKey = j5Kw2AD36sLmFFIMXnMeEcsqhZPTY/ACs+00MYv2ahc=" | sudo tee -a /etc/wireguard/wg0.conf
          echo "AllowedIPs = 0.0.0.0/0, ::/0" | sudo tee -a /etc/wireguard/wg0.conf
          echo "Endpoint = 45.77.30.118:51822" | sudo tee -a /etc/wireguard/wg0.conf
          echo "PersistentKeepalive = 25" | sudo tee -a /etc/wireguard/wg0.conf

      - name: üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN
        run: |
          set -x
          sudo wg-quick up wg0
          echo "üéØ WireGuard —Å—Ç–∞—Ç—É—Å:"
          sudo wg show

      - name: üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –ß–ï–†–ï–ó VPN
        run: |
          set -x
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          sleep 3
          echo "::group::IP —á–µ—Ä–µ–∑ VPN"
          echo "ipinfo.io:"
          curl https://ipinfo.io/ip || echo "‚ùå"
          echo ""
          echo "ifconfig.me:"
          curl https://ifconfig.me || echo "‚ùå"
          echo ""
          echo "api.myip.com:"
          curl https://api.myip.com || echo "‚ùå"
          echo "::endgroup::"

      - name: ‚úÖ Ping —á–µ—Ä–µ–∑ VPN
        run: |
          set -x
          echo "::group::Ping –¥–æ 1.1.1.1 —á–µ—Ä–µ–∑ VPN"
          ping -c 4 1.1.1.1 || echo "‚ùå Ping –Ω–µ –ø—Ä–æ—à—ë–ª"
          echo "::endgroup::"

      - name: üì¥ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VPN
        if: always()
        run: |
          set -x
          sudo wg-quick down wg0
