<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WG Speedtest Dashboard (demo)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    :root {
      --bg: #0f1620;
      --panel: #151e2a;
      --panel-2: #1b2635;
      --text: #e6edf3;
      --muted: #9fb3c8;
      --ok: #17d47b;
      --warn: #f5a524;
      --bad: #ff5d5d;
      --border: #263244;
      --chip: #202b3a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 22px;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    h1 { margin: 0 0 14px; font-size: 22px; }
    .controls {
      display: flex; flex-wrap: wrap; gap: 12px;
      margin: 8px 0 18px;
    }
    .ctrl {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px; display: flex; align-items: center; gap: 8px;
    }
    .ctrl label { color: var(--muted); font-size: 12px; }
    select, button, input[type="checkbox"] {
      background: var(--panel-2); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 8px; font: inherit;
    }
    button { cursor: pointer; }
    .wrap {
      display: grid; grid-template-columns: 1.4fr 0.8fr; gap: 16px;
    }
    .card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 16px; padding: 16px;
    }
    .card h3 { margin: 0 0 12px; font-size: 16px; }
    .legend {
      display: flex; gap: 10px; align-items: center; color: var(--muted); margin-bottom: 10px;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
    }
    .chips { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .chip {
      background: var(--chip); border: 1px solid var(--border);
      border-radius: 999px; padding: 6px 10px; color: var(--muted);
      font-size: 12px;
    }
    table {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
    th { text-align: left; color: var(--muted); font-weight: 600; }
    .pill {
      padding: 2px 8px; border-radius: 999px; font-size: 12px;
      border: 1px solid var(--border);
    }
    .chart-wrap {
      position: relative;
      height: 320px;          /* можно 280–360 по вкусу */
      width: 100%;
      overflow: hidden;       /* на всякий случай */
    }

    #chart {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .muted { color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>WG Speedtest Dashboard (demo)</h1>

  <div class="controls">
    <div class="ctrl">
      <label for="sel-server">Сервер:</label>
      <select id="sel-server">
        <option>us01</option>
        <option>gb01</option>
        <option>de01</option>
        <option>nl01</option>
        <option>se01</option>
        <option>jp01</option>
      </select>
    </div>
    <div class="ctrl">
      <label for="sel-metric">Метрика:</label>
      <select id="sel-metric">
        <option value="download">Download (Mb/s)</option>
        <option value="upload">Upload (Mb/s)</option>
        <option value="ping">Ping (ms)</option>
      </select>
    </div>
    <div class="ctrl">
      <label for="sel-window">Окно:</label>
      <select id="sel-window">
        <option value="10">последние 10 запусков</option>
        <option value="20" selected>последние 20 запусков</option>
        <option value="50">последние 50 запусков</option>
      </select>
    </div>
    <div class="ctrl">
      <label>профили</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <label class="small"><input id="chk-novpn" type="checkbox"> novpn</label>
        <label class="small"><input id="chk-grand" type="checkbox" checked> grand</label>
        <label class="small"><input id="chk-basic" type="checkbox" checked> basic</label>
      </div>
    </div>
    <div class="ctrl">
      <button id="btn-refresh">Обновить</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3>Тайм-серия</h3>
      <div class="legend">
        <span><span class="dot" style="background:#6EA8FE"></span>novpn</span>
        <span><span class="dot" style="background:#5AD8A6"></span>grand</span>
        <span><span class="dot" style="background:#F6BD16"></span>basic</span>
      </div>
      <div class="chart-wrap">
        <canvas id="chart"></canvas>
      </div>
      <div class="chips" id="chips"></div>
      <div class="small" style="margin-top:8px;">
        Пороговые линии: grand↓ &lt; 100 Mb/s, basic↓ &lt; 5 Mb/s, ping &gt; 200 ms.
      </div>
    </div>

    <div class="card">
      <h3>Последние значения</h3>
      <table id="tbl-last">
        <thead>
          <tr>
            <th>Сервер</th><th>Профиль</th><th>Ping</th><th>↓ Mb/s</th><th>↑ Mb/s</th>
            <th>Loss%</th><th>Jitter</th><th>PMTU</th><th>Geo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:10px;">Demo – позже подключим stats.json из артефактов Actions.</div>
    </div>
  </div>

  <div class="small" style="margin-top:16px; text-align:center;">
    Demo • Chart.js • далее подключим реальные данные
  </div>

  <script>
    // ===== Demo data (позже заменим на fetch('stats.json'))
    const demoData = {
      us01: {
        timestamps: Array.from({length: 20}, (_,i)=>Date.now() - (19-i)*1800_000),
        novpn:  [11000, 17000, 12500, 14000, 15800, 16800, 12000,  8200, 15500, 16000, 11200, 9800, 13000, 14800, 16000, 12000, 10800, 13400, 15000, 12000],
        grand:  [  260,   280,   210,   330,   290,   305,   275,   240,   315,   300,   285,   320,   295,   270,   355,   310,   325,   280,   340,   300],
        basic:  [  7.2,   7.6,   6.9,   7.3,   7.5,   7.4,   7.1,   7.2,   7.4,   7.5,   7.3,   7.2,   7.2,   7.3,   7.5,   7.1,   7.4,   7.4,   7.6,   7.2]
      },
      gb01: {
        timestamps: Array.from({length: 20}, (_,i)=>Date.now() - (19-i)*1800_000),
        novpn:  [9000, 10000, 8500, 12000, 13000, 16000, 10000,  7800, 9000, 12000, 13000, 10000, 9000, 14000, 15000, 11600,  9800, 14500, 13500, 11200],
        grand:  [ 320,   360,   300,   340,   390,   420,   310,   280,   330,   410,   360,   300,   290,   400,   420,   380,   330,   360,   350,   340],
        basic:  [ 7.1,   7.2,   7.0,   7.2,   7.5,   7.1,   7.3,   7.0,   7.2,   7.4,   7.5,   7.2,   7.1,   7.3,   7.5,   7.2,   7.1,   7.2,   7.3,   7.1]
      },
      de01: {
        timestamps: Array.from({length: 20}, (_,i)=>Date.now() - (19-i)*1800_000),
        novpn:  [10000, 16500, 10500, 13500, 15500, 16800, 12300,  8600, 12500, 14800, 16000, 11000,  9800, 13000, 16600, 12000, 10800, 13400, 15000, 12000],
        grand:  [ 280,   300,   320,   350,   370,   310,   280,   260,   290,   315,   330,   295,   275,   260,   300,   310,   325,   280,   340,   300],
        basic:  [ 7.3,   7.1,   7.2,   7.4,   7.5,   7.2,   7.3,   7.0,   7.1,   7.4,   7.5,   7.2,   7.2,   7.3,   7.4,   7.1,   7.4,   7.2,   7.5,   7.2]
      },
      last: [
        { server:'us01', profile:'novpn', ping:8.9, down:465.3,  up:363.1,  loss:0.0, jitter:0.02, pmtu:1500, geo:'US' },
        { server:'us01', profile:'grand', ping:41.5,down:134.1,  up:158.3,  loss:0.0, jitter:1.10, pmtu:1420, geo:'US' },
        { server:'us01', profile:'basic', ping:34.8,down:7.5,    up:179.4,  loss:0.0, jitter:0.08, pmtu:1420, geo:'US' },
        { server:'gb01', profile:'grand', ping:99.3,down:461.4,  up:402.1,  loss:0.0, jitter:0.61, pmtu:1420, geo:'GB' },
        { server:'de01', profile:'grand', ping:110.7,down:299.4, up:348.5,  loss:0.0, jitter:0.20, pmtu:1420, geo:'DE' },
      ]
    };

    // ===== UI state
    const elServer  = document.getElementById('sel-server');
    const elMetric  = document.getElementById('sel-metric');
    const elWindow  = document.getElementById('sel-window');
    const elChkNov  = document.getElementById('chk-novpn');
    const elChkGr   = document.getElementById('chk-grand');
    const elChkBs   = document.getElementById('chk-basic');
    const elBtn     = document.getElementById('btn-refresh');
    const elChips   = document.getElementById('chips');
    const elTBody   = document.querySelector('#tbl-last tbody');

    // novpn скрыт по умолчанию
    elChkNov.checked = false;

    const seriesVisibility = { novpn: false, grand: true, basic: true };
    const colors = {
      novpn: '#6EA8FE',
      grand: '#5AD8A6',
      basic: '#F6BD16',
    };

    // novpn не участвует в расчёте масштаба Y (можно включить при желании)
    const INCLUDE_NOVPN_IN_SCALE = false; // NEW

    // ===== Chart init
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        resizeDelay: 150,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm' },
            ticks: { color: '#9fb3c8' }, grid: { color: '#1f2a3a' }
          },
          y: {
            beginAtZero: true, ticks: { color: '#9fb3c8' }, grid: { color: '#1f2a3a' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}`
            }
          }
        },
        elements: { point: { radius: 2 } }
      }
    });

    // Horizontal threshold lines plugin (для download/ping)
    const TH = { grandDL: 100, basicDL: 5, pingRed: 200 };
    Chart.register({
      id: 'thresholds',
      afterDatasetsDraw(c) {
        const metric = elMetric.value;
        if (!['download','ping','upload'].includes(metric)) return;
        const { ctx, chartArea:{top,bottom,left,right}, scales:{y} } = c;
        ctx.save();
        ctx.setLineDash([6,6]);
        ctx.lineWidth = 1;
        ctx.font = '12px system-ui';
        ctx.fillStyle = '#9fb3c8';

        if (metric === 'download') {
          drawH(TH.grandDL, '#5AD8A6');
          drawH(TH.basicDL, '#F6BD16');
        }
        if (metric === 'ping') {
          drawH(TH.pingRed, '#ff5d5d');
        }
        ctx.restore();

        function drawH(val, color) {
          const yPos = y.getPixelForValue(val);
          if (yPos < top || yPos > bottom) return;
          ctx.strokeStyle = color;
          ctx.beginPath(); ctx.moveTo(left, yPos); ctx.lineTo(right, yPos); ctx.stroke();
        }
      }
    });

    function fmtNumber(v) {
      if (v == null || isNaN(v)) return '—';
      return Number(v).toLocaleString('ru-RU');
    }
    function chip(label, value) {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = `${label}: ${value}`;
      return span;
    }
    function buildDatasets(data) {
      const ds = [];
      if (seriesVisibility.novpn && data.novpn) {
        ds.push({ label: 'novpn', borderColor: colors.novpn, tension: 0.25,
          data: data.novpn.map(v => v), hidden: !seriesVisibility.novpn });
      }
      if (seriesVisibility.grand && data.grand) {
        ds.push({ label: 'grand', borderColor: colors.grand, tension: 0.25,
          data: data.grand.map(v => v) });
      }
      if (seriesVisibility.basic && data.basic) {
        ds.push({ label: 'basic', borderColor: colors.basic, tension: 0.25,
          data: data.basic.map(v => v) });
      }
      return ds;
    }

    function updateChart() {
      const sid = elServer.value;
      const metric = elMetric.value;  // download / upload / ping (в демо у нас download)
      const win = parseInt(elWindow.value, 10);
      seriesVisibility.novpn = elChkNov.checked;
      seriesVisibility.grand = elChkGr.checked;
      seriesVisibility.basic = elChkBs.checked;

      const src = demoData[sid] || demoData.us01;
      const idx0 = Math.max(0, (src.timestamps?.length || 0) - win);

      const base = {
        timestamps: (src.timestamps || []).slice(idx0),
        novpn: (src.novpn || []).slice(idx0),
        grand: (src.grand || []).slice(idx0),
        basic: (src.basic || []).slice(idx0)
      };

      // перезаписываем данные (без накопления)
      chart.data.labels = base.timestamps.map(ts => new Date(ts));
      chart.data.datasets = buildDatasets(base);

      // ===== NEW: аккуратный авто-масштаб по видимым рядам (без novpn по умолчанию)
      const pool = [];
      if (seriesVisibility.grand) pool.push(...base.grand.filter(Number.isFinite));
      if (seriesVisibility.basic) pool.push(...base.basic.filter(Number.isFinite));
      if (INCLUDE_NOVPN_IN_SCALE && seriesVisibility.novpn) {
        pool.push(...base.novpn.filter(Number.isFinite));
      }
      const yMax = Math.max(1, ...pool);
      const pad = yMax < 20 ? 5 : yMax * 0.10;
      chart.options.scales.y.beginAtZero = true;
      chart.options.scales.y.suggestedMax = Math.ceil(yMax + pad);

      chart.update('none');

      // резюме под графиком
      elChips.innerHTML = '';
      const lastIdx = base.timestamps.length - 1;
      const nov = base.novpn[lastIdx], gr = base.grand[lastIdx], bs = base.basic[lastIdx];
      if (seriesVisibility.novpn && nov != null) elChips.appendChild(chip('novpn', `${fmtNumber(nov)} Mb/s`));
      if (seriesVisibility.grand && gr != null)  elChips.appendChild(chip('grand', `${fmtNumber(gr)} Mb/s`));
      if (seriesVisibility.basic && bs != null)  elChips.appendChild(chip('basic', `${fmtNumber(bs)} Mb/s`));
      elChips.appendChild(chip('точек', String(base.timestamps.length)));
    }

    function renderLastTable() {
      const rows = (demoData.last || []);
      const tbody = elTBody; tbody.innerHTML = '';
      if (!rows.length) return;

      for (const r of rows) {
        const tr = document.createElement('tr');
        const lossBad = typeof r.loss === 'number' && r.loss > 1.0;
        const jitterBad = typeof r.jitter === 'number' && r.jitter > 10;
        const pingBad = typeof r.ping === 'number' && r.ping > 200;
        const mtugood = (r.pmtu || 0) >= 1400;

        tr.innerHTML = `
          <td>${r.server}</td>
          <td><span class="pill">${r.profile}</span></td>
          <td class="${pingBad?'bad':''}">${r.ping ?? '—'}</td>
          <td>${r.down ?? '—'}</td>
          <td>${r.up ?? '—'}</td>
          <td class="${lossBad?'bad':'ok'}">${r.loss ?? '—'}</td>
          <td class="${jitterBad?'bad':'ok'}">${r.jitter ?? '—'}</td>
          <td class="${mtugood?'ok':'bad'}">${r.pmtu ?? '—'}</td>
          <td>${r.geo ?? ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // events
    elBtn.addEventListener('click', updateChart);
    elServer.addEventListener('change', updateChart);
    elMetric.addEventListener('change', updateChart);
    elWindow.addEventListener('change', updateChart);
    elChkNov.addEventListener('change', updateChart);
    elChkGr.addEventListener('change', updateChart);
    elChkBs.addEventListener('change', updateChart);

    // first paint
    renderLastTable();
    updateChart();
  </script>
</body>
</html>